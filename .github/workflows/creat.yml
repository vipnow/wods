name: Update IPTV

on:
  schedule:
    - cron: '02 22 * * *' # 每天的北京时间06:02启动 (UTC时间22:02)
  workflow_dispatch: # 手动触发

jobs:
  update-iptv:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install curl
      run: sudo apt-get install -y curl

    - name: Fetch IP data and Update templates
      run: |
        mkdir -p result
        if [ -d "template" ] && [ "$(ls -A template/*.txt 2>/dev/null)" ]; then
          for ip_file in result/*.txt; do
            region_name=$(basename $ip_file .txt)
            template_file="template/${region_name}.txt"
            if [ -f "$template_file" ]; then
              ips=$(cat $ip_file)
              template_content=$(cat $template_file)
              for ip in $ips; do
                template_content=$(echo "$template_content" | sed "s/ipipip/$ip/g")
              done
              echo "$template_content" > "result/${region_name}.txt"
            fi
          done
        else
          echo "No template files found in template or result files found in result. Skipping update process."
        fi

    - name: Combine results
      run: |
        if [ -d "result" ] && [ "$(ls -A result/*.txt 2>/dev/null)" ]; then
          rm -f result/all.txt
          for result_file in result/*.txt; do
            [[ $result_file == *"_ips.txt" ]] && continue
            genre=""
            while IFS= read -r line; do
              if [[ "$line" == *"#genre#"* ]]; then
                genre="$line"
                if ! grep -q "$genre" result/all.txt; then
                  echo "$genre" >> result/all.txt
                fi
              else
                echo "$line" >> result/all.txt
              fi
            done < "$result_file"
          done
        else
          echo "No result files found in result. Skipping combine results step."
        fi
